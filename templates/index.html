<!DOCTYPE html>
<html>
<head>
    <title>File Upload</title>
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        form {
            width: 90%;
            max-width: 500px;
            margin: 20px;
        }

        #barContainer {
            width: 90%;
            max-width: 500px;
            background-color: #ddd;
            margin: 20px 0;
        }

        #progressBar {
            width: 0%;
            height: 30px;
            background-color: green;
            text-align: center;
            line-height: 30px;
            color: white;
        }

        img, video, audio {
            max-width: 90%;
            height: auto;
        }

        .file-list div {
            border: 2px solid #4CAF50; /* Green border */
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .button {
            background-color: #4CAF50; /* Green */
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 5px;
        }
    </style>
</head>
<body>
<h1>File Upload</h1>
<form action="/upload" enctype="multipart/form-data" id="uploadForm" method="post">
    <input multiple name="files" type="file">
    <input onclick="uploadFiles()" type="button" value="Upload">
    <button disabled id="cancelButton" onclick="cancelUpload()" type="button">Cancel Upload</button>
</form>
<div id="barContainer">
    <div id="progressBar">0%</div>
</div>
<div id="uploadSpeed">Upload Speed: 0 KB/s</div>
<div id="uploadRemainingTime"></div>
<div id="serverPing">Server Ping: ...</div>
<h2>Uploaded Files</h2>
<div class="file-list">
    {% for file in files %}
    <div id="{{ file }}">
        <p>{{ file.name }} - {{ file.size_mb }} MB ({{ file.size_kb }} KB)</p>
        {% if file.name.endswith(('.png', '.jpg', '.jpeg', '.gif')) %}
        <img alt="Thumbnail" src="{{ url_for('uploaded_file', filename=file.name) }}" style="width: auto; height: auto;">
        {% elif file.name.endswith(('.mp4', '.mov', '.avi')) %}
        <video controls width="160">
            <source src="{{ url_for('uploaded_file', filename=file.name) }}" type="video/mp4">
            Your browser does not support the video tag.
        </video>
        {% elif file.name.endswith(('.mp3', '.wav', '.ogg')) %}
        <audio controls>
            <source src="{{ url_for('uploaded_file', filename=file.name) }}" type="audio/mpeg">
            Your browser does not support the audio element.
        </audio>
        <img alt="Audio File" src="/static/audio_icon.png" style="width: 100px; height: auto;">
        {% endif %}

        <div>
            <a class="button" download="{{ file.name }}" href="{{ url_for('uploaded_file', filename=file.name) }}">Download</a>
            <button class="button" onclick="removeFile('{{ file.name }}')">Remove</button>
        </div>
    </div>
    {% endfor %}
</div>
<script>
    var xhr = new XMLHttpRequest();

    function uploadFiles() {
        var form = document.getElementById('uploadForm');
        var formData = new FormData(form);
        xhr.open('POST', '/upload', true);

        var startTime = new Date().getTime(); // Start time of the upload

        xhr.upload.onprogress = function (e) {
            if (e.lengthComputable) {
                var currentTime = new Date().getTime(); // Current time on each progress event
                var durationInSeconds = (currentTime - startTime) / 1000; // Duration in seconds
                var bytesPerSecond = e.loaded / durationInSeconds;
                var kbPerSecond = (bytesPerSecond / 1024).toFixed(2); // Speed in KB/s
                var remainingBytes = e.total - e.loaded;
                var remainingTimeInSeconds = remainingBytes / bytesPerSecond;

                var percentComplete = (e.loaded / e.total) * 100;
                document.getElementById('progressBar').style.width = percentComplete + '%';
                document.getElementById('progressBar').innerText = Math.round(percentComplete) + '%';

                document.getElementById('uploadSpeed').innerText = 'Upload Speed: ' + kbPerSecond + ' KB/s';
                document.getElementById('uploadRemainingTime').innerText = 'Time Remaining: ' + formatSeconds(remainingTimeInSeconds);
            }
        };

        xhr.onload = function () {
            if (xhr.status === 200) {
                document.getElementById('cancelButton').disabled = true;
                window.location.reload();  // Reload the page to update the file list
            } else {
                alert('An error occurred!');
            }
        };

        xhr.onerror = function () {
            alert('An error occurred during the upload.');
        };

        xhr.send(formData);
        document.getElementById('cancelButton').disabled = false;
    }

    function cancelUpload() {
        xhr.abort();  // Cancel the ongoing upload
        document.getElementById('progressBar').style.width = '0%';
        document.getElementById('progressBar').innerText = 'Upload Canceled';
        document.getElementById('cancelButton').disabled = true;
    }

    function removeFile(filename) {
        if (confirm('Are you sure you want to delete this file?')) {
            fetch('/delete/' + filename, {method: 'POST'})
                .then(response => {
                    if (response.ok) {
                        alert('File successfully deleted.');
                        window.location.reload();  // Refresh the page
                    } else {
                        alert('Failed to delete the file.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the file.');
                });
        }
    }

    function formatSeconds(seconds) {
        const hrs = Math.floor(seconds / 3600);
        const mins = Math.floor((seconds % 3600) / 60);
        const secs = Math.floor(seconds % 60);
        return `${hrs}h ${mins}m ${secs}s`;
    }

    function checkPing() {
        var startTime = Date.now();
        fetch('/ping')
            .then(response => response.text())
            .then(data => {
                var endTime = Date.now();
                var ping = endTime - startTime;
                document.getElementById('serverPing').innerText = 'Server Ping: ' + ping + ' ms';
            })
            .catch(error => {
                console.error('Error checking ping:', error);
                document.getElementById('serverPing').innerText = 'Error checking ping';
            });
    }

    // Check ping every 5 seconds
    checkPing()
    setInterval(checkPing, 5000);
</script>
</body>
</html>